OrderReviewController=Class.create();OrderReviewController.prototype={_canSubmitOrder:false,_pleaseWait:false,shippingSelect:false,reloadByShippingSelect:false,_copyElement:false,onSubmitShippingSuccess:false,shippingMethodsUpdateUrl:false,_updateShippingMethods:false,_ubpdateOrderButton:false,shippingMethodsContainer:false,_submitUpdateOrderUrl:false,_itemsGrid:false,initialize:function(orderForm,orderFormSubmit,shippingSelect,shippingSubmitForm,shippingResultId,shippingSubmit){if(!orderForm){return}this.form=orderForm;if(orderFormSubmit){this.formSubmit=orderFormSubmit;Event.observe(orderFormSubmit,"click",this._submitOrder.bind(this))}if(shippingSubmitForm){this.reloadByShippingSelect=true;if(shippingSubmitForm&&shippingSelect){this.shippingSelect=shippingSelect;Event.observe(shippingSelect,"change",this._submitShipping.bindAsEventListener(this,shippingSubmitForm.action,shippingResultId));this._updateOrderSubmit(false)}else{this._canSubmitOrder=true}}else{Form.getElements(this.form).each(this._bindElementChange,this);if(shippingSelect&&$(shippingSelect)){this.shippingSelect=$(shippingSelect).id;this.shippingMethodsContainer=$(this.shippingSelect).up()}else{this.shippingSelect=shippingSelect}this._updateOrderSubmit(false)}},addPleaseWait:function(element){if(element){this._pleaseWait=element}},_submitShipping:function(event,url,resultId){if(this.shippingSelect&&url&&resultId){this._updateOrderSubmit(true);if(this._pleaseWait){this._pleaseWait.show()}if(""!=this.shippingSelect.value){new Ajax.Updater(resultId,url,{parameters:{isAjax:true,shipping_method:this.shippingSelect.value},onComplete:function(){if(this._pleaseWait){this._pleaseWait.hide()}}.bind(this),onSuccess:this._onSubmitShippingSuccess.bind(this),evalScripts:true})}}},setUpdateButton:function(element,url,resultId){if(element){this._ubpdateOrderButton=element;this._submitUpdateOrderUrl=url;this._itemsGrid=resultId;Event.observe(element,"click",this._submitUpdateOrder.bindAsEventListener(this,url,resultId));if(this.shippingSelect){this._updateShipping()}this._updateOrderSubmit(!this._validateForm());this.formValidator.reset();this._clearValidation("")}},setCopyElement:function(element){if(element){this._copyElement=element;Event.observe(element,"click",this._copyShippingToBilling.bind(this));this._copyShippingToBilling()}},setShippingAddressContainer:function(element){if(element){Form.getElements(element).each(function(input){if(input.type.toLowerCase()=="radio"||input.type.toLowerCase()=="checkbox"){Event.observe(input,"click",this._onShippingChange.bindAsEventListener(this))}else{Event.observe(input,"change",this._onShippingChange.bindAsEventListener(this))}},this)}},setShippingMethodContainer:function(element){if(element){this.shippingMethodsContainer=element}},_copyElementValue:function(el){var newId=el.id.replace("shipping:","billing:");if(newId&&$(newId)&&$(newId).type!="hidden"){$(newId).value=el.value;$(newId).setAttribute("readOnly","readonly");$(newId).addClassName("local-validation");$(newId).setStyle({opacity:0.5});$(newId).disable()}},_copyShippingToBilling:function(event){if(!this._copyElement){return}if(this._copyElement.checked){this._copyElementValue($("shipping:country_id"));billingRegionUpdater.update();$$('[id^="shipping:"]').each(this._copyElementValue);this._clearValidation("billing")}else{$$('[id^="billing:"]').invoke("enable");$$('[id^="billing:"]').each(function(el){el.removeAttribute("readOnly")});$$('[id^="billing:"]').invoke("removeClassName","local-validation");$$('[id^="billing:"]').invoke("setStyle",{opacity:1})}if(event){this._updateOrderSubmit(true)}},_submitUpdateOrder:function(event,url,resultId){this._copyShippingToBilling();if(url&&resultId&&this._validateForm()){if(this._copyElement&&this._copyElement.checked){this._clearValidation("billing")}this._updateOrderSubmit(true);if(this._pleaseWait){this._pleaseWait.show()}this._toggleButton(this._ubpdateOrderButton,true);arr=$$('[id^="billing:"]').invoke("enable");var formData=this.form.serialize(true);if(this._copyElement.checked){$$('[id^="billing:"]').invoke("disable");this._copyElement.enable()}formData.isAjax=true;new Ajax.Updater(resultId,url,{parameters:formData,onComplete:function(){if(this._pleaseWait&&!this._updateShippingMethods){this._pleaseWait.hide()}this._toggleButton(this._ubpdateOrderButton,false)}.bind(this),onSuccess:this._updateShippingMethodsElement.bind(this),evalScripts:true})}else{if(this._copyElement&&this._copyElement.checked){this._clearValidation("billing")}}},_updateShippingMethodsElement:function(){if(this._updateShippingMethods){new Ajax.Updater($(this.shippingMethodsContainer).up(),this.shippingMethodsUpdateUrl,{onComplete:this._updateShipping.bind(this),onSuccess:this._onSubmitShippingSuccess.bind(this),evalScripts:false})}else{this._onSubmitShippingSuccess()}},_updateShipping:function(){if($(this.shippingSelect)){$(this.shippingSelect).enable();Event.stopObserving($(this.shippingSelect),"change");this._bindElementChange($(this.shippingSelect));Event.observe($(this.shippingSelect),"change",this._submitUpdateOrder.bindAsEventListener(this,this._submitUpdateOrderUrl,this._itemsGrid));$(this.shippingSelect+"_update").hide();$(this.shippingSelect).show()}this._updateShippingMethods=false;if(this._pleaseWait){this._pleaseWait.hide()}},_validateForm:function(){if(!this.form){return false}if(!this.formValidator){this.formValidator=new Validation(this.form)}return this.formValidator.validate()},_onShippingChange:function(event){var element=Event.element(event);if(element!=$(this.shippingSelect)&&!($(this.shippingSelect)&&$(this.shippingSelect).disabled)){if($(this.shippingSelect)){$(this.shippingSelect).disable();$(this.shippingSelect).hide();if($("advice-required-entry-"+this.shippingSelect)){$("advice-required-entry-"+this.shippingSelect).hide()}}if(this.shippingMethodsContainer&&$(this.shippingMethodsContainer)){$(this.shippingMethodsContainer).hide()}if(this.shippingSelect&&$(this.shippingSelect+"_update")){$(this.shippingSelect+"_update").show()}this._updateShippingMethods=true}},_bindElementChange:function(input){Event.observe(input,"change",this._onElementChange.bindAsEventListener(this))},_onElementChange:function(){this._updateOrderSubmit(true)},_clearValidation:function(idprefix){var prefix="";if(idprefix){prefix='[id*="'+idprefix+':"]';$$(prefix).each(function(el){el.up().removeClassName("validation-failed").removeClassName("validation-passed").removeClassName("validation-error")})}else{this.formValidator.reset()}$$(".validation-advice"+prefix).invoke("remove");$$(".validation-failed"+prefix).invoke("removeClassName","validation-failed");$$(".validation-passed"+prefix).invoke("removeClassName","validation-passed");$$(".validation-error"+prefix).invoke("removeClassName","validation-error")},_submitOrder:function(){if(this._canSubmitOrder&&(this.reloadByShippingSelect||this._validateForm())){this.form.submit();this._updateOrderSubmit(true);if(this._ubpdateOrderButton){this._ubpdateOrderButton.addClassName("no-checkout");this._ubpdateOrderButton.setStyle({opacity:0.5})}if(this._pleaseWait){this._pleaseWait.show()}return}this._updateOrderSubmit(true)},_onSubmitShippingSuccess:function(){this._updateOrderSubmit(false);if(this.onSubmitShippingSuccess){this.onSubmitShippingSuccess()}},_updateOrderSubmit:function(shouldDisable){var isDisabled=shouldDisable||(this.reloadByShippingSelect&&(!this.shippingSelect||""==this.shippingSelect.value));this._canSubmitOrder=!isDisabled;if(this.formSubmit){this._toggleButton(this.formSubmit,isDisabled)}},_toggleButton:function(button,disable){button.disabled=disable;button.removeClassName("no-checkout");button.setStyle({opacity:1});if(disable){button.addClassName("no-checkout");button.setStyle({opacity:0.5})}}};